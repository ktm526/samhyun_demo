<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebRTC ì˜ìƒ ì†¡ì¶œ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e4e4e7;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 1.8rem;
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .card-title {
      font-size: 0.9rem;
      color: #a1a1aa;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: flex-end;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    label {
      font-size: 0.75rem;
      color: #71717a;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    input, select {
      padding: 10px 15px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #e4e4e7;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s;
    }
    
    input:focus, select:focus {
      border-color: #3b82f6;
    }
    
    input::placeholder {
      color: #52525b;
    }
    
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    
    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #a1a1aa;
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .video-container {
      position: relative;
      width: 100%;
      padding-top: 56.25%;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
    }
    
    video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .status-disconnected {
      background: rgba(113, 113, 122, 0.2);
      color: #71717a;
    }
    .status-disconnected .status-dot { background: #71717a; }
    
    .status-connecting {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }
    .status-connecting .status-dot { 
      background: #f59e0b;
      animation: pulse 1s infinite;
    }
    
    .status-connected {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }
    .status-connected .status-dot { 
      background: #22c55e;
      box-shadow: 0 0 8px #22c55e;
    }
    
    .status-error {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }
    .status-error .status-dot { background: #ef4444; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    .info-box {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }
    
    .info-box h4 {
      color: #3b82f6;
      font-size: 0.85rem;
      margin-bottom: 10px;
    }
    
    .info-box p {
      font-size: 0.8rem;
      color: #a1a1aa;
      line-height: 1.6;
    }
    
    .info-box code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      color: #f59e0b;
    }
    
    .viewers {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      color: #a1a1aa;
    }
    
    .viewers-count {
      background: rgba(139, 92, 246, 0.2);
      color: #8b5cf6;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
    }
    
    .log {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;
      max-height: 150px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.75rem;
      color: #71717a;
    }
    
    .log-entry {
      padding: 2px 0;
    }
    
    .log-entry.info { color: #3b82f6; }
    .log-entry.success { color: #22c55e; }
    .log-entry.error { color: #ef4444; }
    .log-entry.warning { color: #f59e0b; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¹ WebRTC ì˜ìƒ ì†¡ì¶œ</h1>
    
    <!-- ì„¤ì • ì¹´ë“œ -->
    <div class="card">
      <div class="card-title">
        <span>âš™ï¸</span>
        ì—°ê²° ì„¤ì •
      </div>
      <div class="controls">
        <div class="control-group">
          <label>ì‹œê·¸ë„ë§ ì„œë²„</label>
          <input type="text" id="serverUrl" value="ws://localhost:8083" placeholder="ws://ì„œë²„ì£¼ì†Œ:8083">
        </div>
        <div class="control-group">
          <label>ë°© ID</label>
          <input type="text" id="roomId" value="robot-front" placeholder="ê³ ìœ í•œ ë°© ID">
        </div>
        <div class="control-group">
          <label>ë¹„ë””ì˜¤ ì†ŒìŠ¤</label>
          <select id="videoSource">
            <option value="">ë¡œë”© ì¤‘...</option>
          </select>
        </div>
        <button id="startBtn" class="btn-primary" onclick="startBroadcast()">
          <span>â–¶</span> ì†¡ì¶œ ì‹œì‘
        </button>
        <button id="stopBtn" class="btn-danger" onclick="stopBroadcast()" disabled>
          <span>â¹</span> ì†¡ì¶œ ì¤‘ì§€
        </button>
      </div>
      
      <div class="info-box">
        <h4>ğŸ’¡ ì‚¬ìš© ë°©ë²•</h4>
        <p>
          1. <strong>ì‹œê·¸ë„ë§ ì„œë²„</strong>: ACS ë°±ì—”ë“œ ì„œë²„ ì£¼ì†Œ (ì˜ˆ: <code>ws://192.168.0.10:8083</code>)<br>
          2. <strong>ë°© ID</strong>: ì‹œì²­ìì™€ ê³µìœ í•  ê³ ìœ  ID (ì˜ˆ: <code>robot-front</code>)<br>
          3. <strong>ë¹„ë””ì˜¤ ì†ŒìŠ¤</strong>: ì›¹ìº  ë˜ëŠ” í™”ë©´ ê³µìœ  ì„ íƒ<br>
          4. "ì†¡ì¶œ ì‹œì‘" í´ë¦­ í›„ ACS ì˜ìƒ í˜ì´ì§€ì—ì„œ ê°™ì€ ë°© IDë¡œ ì—°ê²°
        </p>
      </div>
    </div>
    
    <!-- ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ -->
    <div class="card">
      <div class="card-title" style="justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span>ğŸ“º</span>
          ë¯¸ë¦¬ë³´ê¸°
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
          <div class="viewers">
            <span>ğŸ‘¥ ì‹œì²­ì:</span>
            <span id="viewerCount" class="viewers-count">0</span>
          </div>
          <div id="status" class="status status-disconnected">
            <div class="status-dot"></div>
            <span>ì—°ê²° ì•ˆë¨</span>
          </div>
        </div>
      </div>
      <div class="video-container">
        <video id="localVideo" autoplay muted playsinline></video>
      </div>
    </div>
    
    <!-- ë¡œê·¸ ì¹´ë“œ -->
    <div class="card">
      <div class="card-title">
        <span>ğŸ“‹</span>
        ë¡œê·¸
      </div>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    let ws = null;
    let localStream = null;
    const peerConnections = new Map(); // viewerId -> RTCPeerConnection
    let viewerCount = 0;

    // ë¹„ë””ì˜¤ ì†ŒìŠ¤ ëª©ë¡ ë¡œë“œ
    async function loadVideoSources() {
      const select = document.getElementById('videoSource');
      select.innerHTML = '';
      
      try {
        // ë¨¼ì € ê¶Œí•œ ìš”ì²­
        await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        
        videoDevices.forEach((device, index) => {
          const option = document.createElement('option');
          option.value = device.deviceId;
          option.text = device.label || `ì¹´ë©”ë¼ ${index + 1}`;
          select.appendChild(option);
        });
        
        // í™”ë©´ ê³µìœ  ì˜µì…˜ ì¶”ê°€
        const screenOption = document.createElement('option');
        screenOption.value = 'screen';
        screenOption.text = 'ğŸ–¥ï¸ í™”ë©´ ê³µìœ ';
        select.appendChild(screenOption);
        
      } catch (error) {
        log('ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: ' + error.message, 'error');
        select.innerHTML = '<option value="">ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</option>';
      }
    }

    // ë¡œê·¸ ì¶œë ¥
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${time}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(`[${type}] ${message}`);
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateStatus(status, text) {
      const statusDiv = document.getElementById('status');
      statusDiv.className = `status status-${status}`;
      statusDiv.innerHTML = `<div class="status-dot"></div><span>${text}</span>`;
    }

    // ì‹œì²­ì ìˆ˜ ì—…ë°ì´íŠ¸
    function updateViewerCount(count) {
      viewerCount = count;
      document.getElementById('viewerCount').textContent = count;
    }

    // ì†¡ì¶œ ì‹œì‘
    async function startBroadcast() {
      const serverUrl = document.getElementById('serverUrl').value;
      const roomId = document.getElementById('roomId').value;
      const videoSourceId = document.getElementById('videoSource').value;
      
      if (!serverUrl || !roomId) {
        log('ì„œë²„ URLê³¼ ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
        return;
      }

      try {
        updateStatus('connecting', 'ì—°ê²° ì¤‘...');
        log('ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ íšë“ ì¤‘...');

        // ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ íšë“
        if (videoSourceId === 'screen') {
          localStream = await navigator.mediaDevices.getDisplayMedia({
            video: { cursor: 'always' },
            audio: false
          });
        } else {
          localStream = await navigator.mediaDevices.getUserMedia({
            video: videoSourceId ? { deviceId: { exact: videoSourceId } } : true,
            audio: false
          });
        }

        document.getElementById('localVideo').srcObject = localStream;
        log('ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ íšë“ ì™„ë£Œ', 'success');

        // WebSocket ì—°ê²°
        log(`ì‹œê·¸ë„ë§ ì„œë²„ ì—°ê²°: ${serverUrl}`);
        ws = new WebSocket(serverUrl);

        ws.onopen = () => {
          log('ì‹œê·¸ë„ë§ ì„œë²„ ì—°ê²° ì„±ê³µ', 'success');
          ws.send(JSON.stringify({
            type: 'join-as-broadcaster',
            roomId
          }));
        };

        ws.onmessage = async (event) => {
          const data = JSON.parse(event.data);
          await handleSignalingMessage(data);
        };

        ws.onerror = (error) => {
          log('WebSocket ì˜¤ë¥˜', 'error');
          updateStatus('error', 'ì—°ê²° ì˜¤ë¥˜');
        };

        ws.onclose = () => {
          log('WebSocket ì—°ê²° ì¢…ë£Œ', 'warning');
          updateStatus('disconnected', 'ì—°ê²° ì•ˆë¨');
        };

        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;

      } catch (error) {
        log('ì†¡ì¶œ ì‹œì‘ ì˜¤ë¥˜: ' + error.message, 'error');
        updateStatus('error', 'ì˜¤ë¥˜');
      }
    }

    // ì‹œê·¸ë„ë§ ë©”ì‹œì§€ ì²˜ë¦¬
    async function handleSignalingMessage(data) {
      switch (data.type) {
        case 'joined':
          log(`ë°© ì°¸ê°€ ì™„ë£Œ: ${data.roomId}`, 'success');
          updateStatus('connected', 'ì†¡ì¶œ ì¤‘');
          break;

        case 'viewer-joined':
          log(`ìƒˆ ì‹œì²­ì ì—°ê²°: ${data.viewerId}`);
          await createPeerConnection(data.viewerId);
          updateViewerCount(viewerCount + 1);
          break;

        case 'viewer-left':
          log(`ì‹œì²­ì í‡´ì¥: ${data.viewerId}`);
          closePeerConnection(data.viewerId);
          updateViewerCount(Math.max(0, viewerCount - 1));
          break;

        case 'answer':
          await handleAnswer(data.viewerId, data.answer);
          break;

        case 'ice-candidate':
          await handleIceCandidate(data.viewerId, data.candidate);
          break;

        case 'error':
          log('ì˜¤ë¥˜: ' + data.message, 'error');
          break;
      }
    }

    // PeerConnection ìƒì„± ë° Offer ì „ì†¡
    async function createPeerConnection(viewerId) {
      try {
        const pc = new RTCPeerConnection({
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
          ]
        });

        peerConnections.set(viewerId, pc);

        // ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ ì¶”ê°€
        localStream.getTracks().forEach(track => {
          pc.addTrack(track, localStream);
        });

        // ICE Candidate ì „ì†¡
        pc.onicecandidate = (event) => {
          if (event.candidate && ws?.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
              type: 'ice-candidate',
              viewerId,
              candidate: event.candidate
            }));
          }
        };

        // ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
        pc.onconnectionstatechange = () => {
          log(`${viewerId} ì—°ê²° ìƒíƒœ: ${pc.connectionState}`);
        };

        // Offer ìƒì„± ë° ì „ì†¡
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        if (ws?.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'offer',
            viewerId,
            offer: pc.localDescription
          }));
        }

        log(`${viewerId}ì—ê²Œ Offer ì „ì†¡`, 'info');

      } catch (error) {
        log(`PeerConnection ìƒì„± ì˜¤ë¥˜: ${error.message}`, 'error');
      }
    }

    // Answer ì²˜ë¦¬
    async function handleAnswer(viewerId, answer) {
      const pc = peerConnections.get(viewerId);
      if (pc) {
        await pc.setRemoteDescription(new RTCSessionDescription(answer));
        log(`${viewerId}ë¡œë¶€í„° Answer ìˆ˜ì‹ `, 'success');
      }
    }

    // ICE Candidate ì²˜ë¦¬
    async function handleIceCandidate(viewerId, candidate) {
      const pc = peerConnections.get(viewerId);
      if (pc && candidate) {
        await pc.addIceCandidate(new RTCIceCandidate(candidate));
      }
    }

    // PeerConnection ì¢…ë£Œ
    function closePeerConnection(viewerId) {
      const pc = peerConnections.get(viewerId);
      if (pc) {
        pc.close();
        peerConnections.delete(viewerId);
      }
    }

    // ì†¡ì¶œ ì¤‘ì§€
    function stopBroadcast() {
      // WebSocket ì¢…ë£Œ
      if (ws) {
        ws.close();
        ws = null;
      }

      // ëª¨ë“  PeerConnection ì¢…ë£Œ
      peerConnections.forEach((pc, viewerId) => {
        pc.close();
      });
      peerConnections.clear();

      // ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }

      document.getElementById('localVideo').srcObject = null;
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      
      updateStatus('disconnected', 'ì—°ê²° ì•ˆë¨');
      updateViewerCount(0);
      log('ì†¡ì¶œ ì¤‘ì§€', 'warning');
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¹„ë””ì˜¤ ì†ŒìŠ¤ ëª©ë¡ ë¡œë“œ
    window.onload = loadVideoSources;
    
    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì •ë¦¬
    window.onbeforeunload = stopBroadcast;
  </script>
</body>
</html>


