<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="wheelchair_ignition_plugins">
  <!-- Diff Drive and basic sensor plugins for Ignition Gazebo -->

  <!-- Joint state publisher plugin is still useful; sensors system is already loaded by default world -->
  <gazebo>
      <plugin filename="ignition-gazebo-sensors-system" name="ignition::gazebo::systems::Sensors">
        <render_engine>ogre2</render_engine>
      </plugin>

      <plugin filename="ignition-gazebo-joint-state-publisher-system" name="ignition::gazebo::systems::JointStatePublisher">
      </plugin>
  </gazebo>

  <!-- Differential drive using the main wheels -->
  <gazebo>
    <plugin filename="ignition-gazebo-diff-drive-system" name="ignition::gazebo::systems::DiffDrive">
      <left_joint>$(arg wheel_left_joint)</left_joint>
      <right_joint>$(arg wheel_right_joint)</right_joint>
      <wheel_separation>$(arg wheel_separation)</wheel_separation>
      <wheel_radius>$(arg wheel_radius)</wheel_radius>
      <odom_publish_frequency>$(arg odom_publish_frequency)</odom_publish_frequency>
      <topic>$(arg cmd_vel_topic)</topic>
      <frame_id>$(arg odom_frame_id)</frame_id>
      <child_frame_id>$(arg base_footprint_frame_id)</child_frame_id>
    </plugin>
  </gazebo>

  <!-- Wheel physics properties -->
  <!-- Drive wheels - high friction for good traction -->
  <!-- <gazebo reference="wheel_r_link">
    <mu1>5.0</mu1>
    <mu2>5.0</mu2>
    <kp>1000000.0</kp>
    <kd>100.0</kd>
    <minDepth>0.001</minDepth>
    <maxVel>3.0</maxVel>
    <maxVel2>1.5</maxVel2>
  </gazebo>
  <gazebo reference="wheel_l_link">
    <mu1>5.0</mu1>
    <mu2>5.0</mu2>
    <kp>1000000.0</kp>
    <kd>100.0</kd>
    <minDepth>0.001</minDepth>
    <maxVel>3.0</maxVel>
    <maxVel2>1.5</maxVel2>
  </gazebo> -->

  <!-- Caster wheels - almost no friction to minimize interference -->
  <gazebo reference="caster_wheel_r_link">
    <mu1>0.0001</mu1>
    <mu2>0.0001</mu2>
    <kp>1000000.0</kp>
    <kd>100.0</kd>
    <minDepth>0.001</minDepth>
    <maxVel>0.1</maxVel>
    <maxVel2>0.05</maxVel2>
  </gazebo>
  <gazebo reference="caster_wheel_l_link">
    <mu1>0.0001</mu1>
    <mu2>0.0001</mu2>
    <kp>1000000.0</kp>
    <kd>100.0</kd>
    <minDepth>0.001</minDepth>
    <maxVel>0.1</maxVel>
    <maxVel2>0.05</maxVel2>
  </gazebo>

  <gazebo>
      <plugin filename="libignition-gazebo6-odometry-publisher-system"
          name="ignition::gazebo::systems::OdometryPublisher">
          <odom_frame>$(arg odom_frame_id)</odom_frame>
          <robot_base_frame>$(arg base_footprint_frame_id)</robot_base_frame>
          <odom_topic>$(arg odom_topic)</odom_topic>
          <tf_topic>$(arg tf_topic)</tf_topic>
          <dimensions>2</dimensions>
          <odom_publish_frequency>$(arg odom_publish_frequency)</odom_publish_frequency>
      </plugin>
  </gazebo>

  <!-- 2D LiDAR sensors (if lidar_enabled) -->
  <xacro:if value="$(arg lidar_enabled)">
    <!-- Right LiDAR -->
    <gazebo reference="lidar_r_link">
      <sensor name="gpu_lidar_right" type="gpu_lidar">
        <topic>$(arg scan_right_topic)</topic>
        <update_rate>$(arg lidar_update_rate)</update_rate>
        <ignition_frame_id>$(arg lidar_r_frame_id)</ignition_frame_id>
        <lidar>
          <scan>
            <horizontal>
              <samples>$(arg lidar_samples)</samples>
              <resolution>$(arg lidar_resolution)</resolution>
              <min_angle>$(arg lidar_min_angle)</min_angle>
              <max_angle>$(arg lidar_max_angle)</max_angle>
            </horizontal>
          </scan>
          <range>
            <min>$(arg lidar_range_min)</min>
            <max>$(arg lidar_range_max)</max>
            <resolution>$(arg lidar_range_resolution)</resolution>
          </range>
          <noise>
              <type>gaussian</type>
              <mean>$(arg lidar_noise_mean)</mean>
              <stddev>$(arg lidar_noise_stddev)</stddev>
          </noise>
        </lidar>
        <alwaysOn>$(arg lidar_always_on)</alwaysOn>
        <visualize>$(arg lidar_visualize)</visualize>
      </sensor>
    </gazebo>

    <!-- Left LiDAR -->
    <gazebo reference="lidar_l_link">
      <sensor name="gpu_lidar_left" type="gpu_lidar">
        <topic>$(arg scan_left_topic)</topic>
        <update_rate>$(arg lidar_update_rate)</update_rate>
        <ignition_frame_id>$(arg lidar_l_frame_id)</ignition_frame_id>
        <lidar>
          <scan>
            <horizontal>
              <samples>$(arg lidar_samples)</samples>
              <resolution>$(arg lidar_resolution)</resolution>
              <min_angle>$(arg lidar_min_angle)</min_angle>
              <max_angle>$(arg lidar_max_angle)</max_angle>
            </horizontal>
          </scan>
          <range>
            <min>$(arg lidar_range_min)</min>
            <max>$(arg lidar_range_max)</max>
            <resolution>$(arg lidar_range_resolution)</resolution>
          </range>
          <noise>
              <type>gaussian</type>
              <mean>$(arg lidar_noise_mean)</mean>
              <stddev>$(arg lidar_noise_stddev)</stddev>
          </noise>
        </lidar>
        <alwaysOn>$(arg lidar_always_on)</alwaysOn>
        <visualize>$(arg lidar_visualize)</visualize>
      </sensor>
    </gazebo>
  </xacro:if>

  <!-- Cameras (if camera_enabled) -->
  <xacro:if value="$(arg camera_enabled)">
    <!-- Right camera -->
    <gazebo reference="camera_r_link">
      <sensor type="camera" name="camera_right">
        <update_rate>$(arg camera_update_rate)</update_rate>
        <topic>$(arg camera_right_image_topic)</topic>
        <ignition_frame_id>$(arg camera_r_optical_link_frame_id)</ignition_frame_id>
        <camera_info_topic>$(arg camera_right_camera_info_topic)</camera_info_topic>
        <horizontal_fov>$(arg camera_right_horizontal_fov)</horizontal_fov>
        <image>
          <width>$(arg camera_right_width)</width>
          <height>$(arg camera_right_height)</height>
          <format>$(arg camera_right_format)</format>
        </image>
        <clip><near>$(arg camera_right_near)</near><far>$(arg camera_right_far)</far></clip>
      </sensor>
    </gazebo>

    <!-- Left camera -->
    <gazebo reference="camera_l_link">
      <sensor type="camera" name="camera_left">
        <update_rate>$(arg camera_update_rate)</update_rate>
        <topic>$(arg camera_left_image_topic)</topic>
        <ignition_frame_id>$(arg camera_l_optical_link_frame_id)</ignition_frame_id>
        <camera_info_topic>$(arg camera_left_camera_info_topic)</camera_info_topic>
        <horizontal_fov>$(arg camera_left_horizontal_fov)</horizontal_fov>
        <image>
          <width>$(arg camera_left_width)</width>
          <height>$(arg camera_left_height)</height>
          <format>$(arg camera_left_format)</format>
        </image>
        <clip><near>$(arg camera_left_near)</near><far>$(arg camera_left_far)</far></clip>
      </sensor>
    </gazebo>
  </xacro:if>

  <!-- IMU (if imu_enabled) -->
  <xacro:if value="$(arg imu_enabled)">
    <gazebo reference="imu_frame">
      <sensor name="imu_sensor" type="imu">
        <update_rate>$(arg imu_update_rate)</update_rate>
        <ignition_frame_id>$(arg imu_frame_id)</ignition_frame_id>
        <topic>$(arg imu_topic)</topic>
      </sensor>
    </gazebo>
  </xacro:if>

</robot> 